import http from '@ohos.net.http';
import image from '@ohos.multimedia.image';
// Import at module level to avoid circular dependency
import appServer from '../api/appServer';

export interface SlideVerifyViewDelegate {
  slideVerifyViewDidVerifySuccess(token: string): void;
  slideVerifyViewDidVerifyFailed(): void;
  slideVerifyViewDidLoadFailed(): void;
}

@Component
export struct SlideVerifyView {
  @State token: string = ''
  @State sliderY: number = 0
  @State bgImageData: string = ''
  @State sliderImageData: string = ''
  @State sliderImageTop: number = 0

  @State currentX: number = 0
  @State isVerified: boolean = false
  @State hintOpacity: number = 1
  @State isLoading: boolean = false

  @State scaleX: number = 1
  @State scaleY: number = 1
  @State imageOffsetX: number = 0

  private controller: SlideVerifyController = new SlideVerifyController()
  delegate?: SlideVerifyViewDelegate

  aboutToAppear() {
    this.loadVerifyCode()
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('å®‰å…¨éªŒè¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 15 })

      // å›¾ç‰‡å®¹å™¨
      Stack() {
        // èƒŒæ™¯å›¾
        Image(this.bgImageData)
          .width('100%')
          .height(150)
          .objectFit(ImageFit.Contain)
          .onComplete(() => {
            this.calculateScale()
          })

        // æ»‘å—å›¾
        Image(this.sliderImageData)
          .width(50)
          .height(50)
          .position({ x: this.imageOffsetX + this.currentX, y: this.sliderImageTop })
      }
      .width('100%')
      .height(150)
      .backgroundColor('#f5f5f5')
      .borderRadius(4)
      .margin({ bottom: 15 })

      // æ»‘å—è½¨é“
      Stack() {
        // æç¤ºæ–‡å­—
        Text('å‘å³æ»‘åŠ¨å®ŒæˆéªŒè¯')
          .fontSize(14)
          .fontColor('#999999')
          .opacity(this.hintOpacity)

        // æ»‘å—æŒ‰é’®
        Circle()
          .width(40)
          .height(40)
          .fill(this.isVerified ? '#4CAF50' : Color.White)
          .position({ x: this.currentX, y: 0 })
          .shadow({ radius: this.isVerified ? 0 : 5, color: '#80000000', offsetX: 0, offsetY: 2 })
          .gesture(
            PanGesture({ direction: PanDirection.Horizontal })
              .onActionStart((event: GestureEvent) => {
                if (this.isVerified || this.isLoading) {
                  return
                }
              })
              .onActionUpdate((event: GestureEvent) => {
                if (this.isVerified || this.isLoading) {
                  return
                }
                let newX = event.offsetX
                let maxDistance = 280 // è½¨é“å®½åº¦ - æŒ‰é’®å®½åº¦
                newX = Math.max(0, Math.min(newX, maxDistance))
                this.currentX = newX
                this.hintOpacity = 1 - (newX / maxDistance)
              })
              .onActionEnd((event: GestureEvent) => {
                if (this.isVerified || this.isLoading) {
                  return
                }
                // åªè¦æ»‘åŠ¨è¶…è¿‡ 10pxï¼Œå°±è§¦å‘éªŒè¯
                if (this.currentX >= 10) {
                  this.verifySlidePosition(this.currentX)
                } else {
                  // å›å¼¹
                  this.currentX = 0
                  this.hintOpacity = 1
                }
              })
          )
      }
      .width('100%')
      .height(40)
      .backgroundColor('#f0f0f0')
      .borderRadius(20)
      .margin({ bottom: 10 })

      // åˆ·æ–°æŒ‰é’®
      Row() {
        Text('ğŸ”„')
          .fontSize(20)
          .onClick(() => {
            this.refreshVerify()
          })
      }
      .width(32)
      .height(32)
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('rgba(255, 255, 255, 0.9)')
      .borderRadius(4)
      .shadow({ radius: 8, color: '#80000000', offsetX: 0, offsetY: 2 })
      .position({ x: 290, y: 10 })

      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .color(0x317aff)
      }
    }
    .width(320)
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 20, color: '#80000000', offsetX: 0, offsetY: 4 })
  }

  private async loadVerifyCode() {
    this.isLoading = true
    try {
      console.info('[SlideVerify] å¼€å§‹åŠ è½½éªŒè¯ç ...')
      const response = await appServer.getSlideVerify() as Record<string, Object>
      console.info('[SlideVerify] æœåŠ¡å™¨å“åº”:', JSON.stringify(response))
      this.isLoading = false

      if (response && response['token'] && response['backgroundImage'] && response['sliderImage']) {
        this.token = response['token'] as string
        this.sliderY = response['y'] as number
        console.info('[SlideVerify] Token:', this.token, 'Y:', this.sliderY)

        // è®¾ç½®å›¾ç‰‡ï¼ˆåç«¯å·²è¿”å›å¸¦å‰ç¼€çš„ data URIï¼‰
        this.bgImageData = response['backgroundImage'] as string
        this.sliderImageData = response['sliderImage'] as string
        console.info('[SlideVerify] éªŒè¯ç å›¾ç‰‡åŠ è½½æˆåŠŸ')
      } else {
        console.error('[SlideVerify] å“åº”æ•°æ®ä¸å®Œæ•´:', JSON.stringify(response))
        if (this.delegate) {
          this.delegate.slideVerifyViewDidLoadFailed()
        }
      }
    } catch (error) {
      this.isLoading = false
      console.error('[SlideVerify] åŠ è½½éªŒè¯ç å¤±è´¥:', error)
      if (this.delegate) {
        this.delegate.slideVerifyViewDidLoadFailed()
      }
    }
  }

  private calculateScale() {
    // èƒŒæ™¯å›¾åŸå§‹å°ºå¯¸ï¼š300 x 150
    const naturalWidth = 300
    const naturalHeight = 150
    const containerWidth = 280 // 320 - 20*2
    const containerHeight = 150

    // è®¡ç®—å®¹å™¨çš„å®½é«˜æ¯”å’Œå›¾ç‰‡çš„å®½é«˜æ¯”
    const containerRatio = containerWidth / containerHeight
    const imageRatio = naturalWidth / naturalHeight

    // æ ¹æ® object-fit: contain çš„é€»è¾‘è®¡ç®—å®é™…æ¸²æŸ“å°ºå¯¸
    let renderWidth: number
    let renderHeight: number

    if (imageRatio > containerRatio) {
      // å›¾ç‰‡æ›´å®½ï¼ŒæŒ‰å®½åº¦é€‚é…ï¼Œä¸Šä¸‹ç•™ç™½
      renderWidth = containerWidth
      renderHeight = containerWidth / imageRatio
    } else {
      // å›¾ç‰‡æ›´é«˜ï¼ŒæŒ‰é«˜åº¦é€‚é…ï¼Œå·¦å³ç•™ç™½
      renderHeight = containerHeight
      renderWidth = containerHeight * imageRatio
    }

    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
    this.scaleX = renderWidth / naturalWidth
    this.scaleY = renderHeight / naturalHeight

    // è®¡ç®—å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„åç§»é‡
    const offsetX = (containerWidth - renderWidth) / 2
    const offsetY = (containerHeight - renderHeight) / 2

    this.imageOffsetX = offsetX

    // è®¡ç®—æ»‘å—çš„ Y åæ ‡
    this.sliderImageTop = offsetY + (this.sliderY * this.scaleY)

    console.info('[SlideVerify] å›¾ç‰‡è®¡ç®—:')
    console.info('  åŸå§‹å°ºå¯¸:', naturalWidth, 'x', naturalHeight)
    console.info('  å®¹å™¨å°ºå¯¸:', containerWidth, 'x', containerHeight)
    console.info('  å®é™…æ¸²æŸ“:', renderWidth.toFixed(1), 'x', renderHeight.toFixed(1))
    console.info('  åç§»é‡: offsetX=', offsetX.toFixed(1), ', offsetY=', offsetY.toFixed(1))
    console.info('  ç¼©æ”¾æ¯”ä¾‹: scaleX=', this.scaleX.toFixed(3), ', scaleY=', this.scaleY.toFixed(3))
    console.info('  æ»‘å—ä½ç½®: åŸå§‹Y=', this.sliderY, ', æ˜¾ç¤ºY=', this.sliderImageTop.toFixed(1))
  }

  private refreshVerify() {
    this.loadVerifyCode()
  }

  private reset() {
    this.currentX = 0
    this.isVerified = false
    this.hintOpacity = 1
  }

  private async verifySlidePosition(x: number) {
    try {
      console.info('[SlideVerify] ========== éªŒè¯å¼€å§‹ ==========')
      console.info('[SlideVerify] æ»‘å—æŒ‰é’®åœ¨è½¨é“ä¸Šçš„ä½ç½®:', x, 'px')
      console.info('[SlideVerify] èƒŒæ™¯å›¾åç§» imageOffsetX:', this.imageOffsetX.toFixed(2), 'px')
      console.info('[SlideVerify] ç¼©æ”¾æ¯”ä¾‹ scaleX:', this.scaleX.toFixed(3))

      // è½¬æ¢ä¸ºåŸå›¾åæ ‡
      const originalX = Math.round(x / this.scaleX)
      console.info('[SlideVerify] è½¬æ¢åˆ°åŸå›¾(300x150)çš„Xåæ ‡:', originalX)
      console.info('[SlideVerify] åŸå›¾æœ‰æ•ˆXåæ ‡èŒƒå›´: 50 ~ 200')
      console.info('[SlideVerify] ==================================')

      // æ¨¡ä»¿ iOSï¼Œæ£€æŸ¥ code === 0 åˆ¤æ–­æˆåŠŸ
      const responseStr: string = await appServer.verifySlide(this.token, originalX) as string
      const response = JSON.parse(responseStr) as Record<string, Object>

      console.info('[SlideVerify] API å“åº”:', JSON.stringify(response))
      console.info('[SlideVerify] response.code:', response['code'])
      console.info('[SlideVerify] response.code === 0:', response['code'] === 0)

      if (response['code'] === 0) {
        console.info('[SlideVerify] éªŒè¯æˆåŠŸï¼')
        this.isVerified = true

        // å»¶è¿Ÿå…³é—­
        setTimeout(() => {
          if (this.delegate) {
            this.delegate.slideVerifyViewDidVerifySuccess(this.token)
          }
        }, 500)
      } else {
        console.info('[SlideVerify] éªŒè¯å¤±è´¥ï¼code =', response['code'])
        // éªŒè¯å¤±è´¥
        this.reset()
        if (this.delegate) {
          this.delegate.slideVerifyViewDidVerifyFailed()
        }

        // 1ç§’åè‡ªåŠ¨åˆ·æ–°
        setTimeout(() => {
          this.refreshVerify()
        }, 1000)
      }
    } catch (error) {
      console.error('[SlideVerify] éªŒè¯å¤±è´¥:', error)
      this.reset()
      if (this.delegate) {
        this.delegate.slideVerifyViewDidVerifyFailed()
      }

      // 1ç§’åè‡ªåŠ¨åˆ·æ–°
      setTimeout(() => {
        this.refreshVerify()
      }, 1000)
    }
  }
}

export class SlideVerifyController {
  show() {
    // ç”±å¤–éƒ¨æ§åˆ¶æ˜¾ç¤º
  }

  hide() {
    // ç”±å¤–éƒ¨æ§åˆ¶éšè—
  }
}
